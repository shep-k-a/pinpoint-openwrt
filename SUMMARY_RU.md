# –†–µ–∑—é–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π PinPoint - –ì–æ—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç

## üéØ –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ VPN –Ω–µ —Ä–∞–±–æ—Ç–∞–ª - –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ —à—ë–ª –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `direct-out` –≤–º–µ—Å—Ç–æ VPN —Ç—É–Ω–Ω–µ–ª—è.

## ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

### 1. DNS Detour (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
**–ë—ã–ª–æ**: DNS –∑–∞–ø—Ä–æ—Å—ã —É—Ö–æ–¥–∏–ª–∏ –≤ VPN, —Å–æ–∑–¥–∞–≤–∞—è loopback  
**–°—Ç–∞–ª–æ**: –í—Å–µ DNS —Å–µ—Ä–≤–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `"detour": "direct-out"`

```json
{"tag": "google", "address": "8.8.8.8", "detour": "direct-out"}
```

### 2. Route.final (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
**–ë—ã–ª–æ**: `route.final` –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è, sing-box –≤—ã–±–∏—Ä–∞–ª –ø–µ—Ä–≤—ã–π outbound (direct-out)  
**–°—Ç–∞–ª–æ**: 
- –î–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è VPN: `"final": "direct-out"`
- –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è VPN: `"final": "vpn_tunnel_tag"`

### 3. –ü–æ—Ä—è–¥–æ–∫ Outbounds (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
**–ë—ã–ª–æ**: `[direct-out, VPN, dns-out]` ‚Üí —Ç—Ä–∞—Ñ–∏–∫ —à—ë–ª —á–µ—Ä–µ–∑ direct-out  
**–°—Ç–∞–ª–æ**: `[VPN, direct-out, dns-out]` ‚Üí —Ç—Ä–∞—Ñ–∏–∫ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ VPN

–§—É–Ω–∫—Ü–∏—è `clean_config_outbounds()` —Ç–µ–ø–µ—Ä—å:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ—Ç outbounds
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `route.final` –Ω–∞ –ø–µ—Ä–≤—ã–π VPN —Ç—É–Ω–Ω–µ–ª—å
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ `direct-out` –∏ `dns-out` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏

### 4. NFTables –∏ Routing
**–ë—ã–ª–æ**: –ü–∞–∫–µ—Ç—ã –º–∞—Ä–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å, –Ω–æ –Ω–µ —Ä–æ—É—Ç–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ VPN  
**–°—Ç–∞–ª–æ**: 
- –ü—Ä–∏–æ priority: `raw - 1` (–±—ã–ª–æ `mangle - 1`)
- –î–æ–±–∞–≤–ª–µ–Ω—ã conntrack –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- IP rule priority: `50` (–±—ã–ª–æ `100`)
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π fwmark: `0x1` –≤–µ–∑–¥–µ

### 5. –í–µ—Ä—Å–∏–æ–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ sing-box:
- < 1.11.0: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `"address": ["10.0.0.1/30"]`
- >= 1.11.0: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `"inet4_address": "10.0.0.1/30"`

## üì¶ –ß—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"

### –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
```bash
curl -fsSL https://raw.githubusercontent.com/shep-k-a/pinpoint-openwrt/master/install.sh | sh
```

1. ‚úÖ Sing-box —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: opkg ‚Üí ImmortalWRT ‚Üí GitHub)
2. ‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ DNS detour –∏ route.final
3. ‚úÖ LuCI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω: **Services ‚Üí PinPoint**
4. ‚úÖ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (DoH –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π)
5. ‚úÖ NFTables –ø—Ä–∞–≤–∏–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
6. ‚úÖ Routing –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

### –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ UI:
1. ‚úÖ VPN —Ç—É–Ω–Ω–µ–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
2. ‚úÖ –ü–µ—Ä–≤—ã–π —Ç—É–Ω–Ω–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
3. ‚úÖ `route.final` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ VPN
4. ‚úÖ –ü–æ—Ä—è–¥–æ–∫ outbounds –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
5. ‚úÖ Sing-box –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω

### –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Instagram):
1. ‚úÖ –î–æ–º–µ–Ω—ã —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è –≤ IP
2. ‚úÖ IP –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `tunnel_ips` nftables set
3. ‚úÖ –ü–∞–∫–µ—Ç—ã –º–∞—Ä–∫–∏—Ä—É—é—Ç—Å—è (fwmark 0x1)
4. ‚úÖ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ tun1
5. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ VPN —Ç—É–Ω–Ω–µ–ª—å
6. ‚úÖ **Instagram —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ VPN** ‚ú®

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

### `clean_config_outbounds(config)`
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω—è—é—Ç –∫–æ–Ω—Ñ–∏–≥:
- `update_subscriptions()` ‚Üê **–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—É–Ω–Ω–µ–ª–µ–π**
- `set_active_tunnel()` ‚Üê **–ü—Ä–∏ —Å–º–µ–Ω–µ —Ç—É–Ω–Ω–µ–ª—è**
- `restart()`, `apply()` ‚Üê **–ü–µ—Ä–µ–¥ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–º**
- `set_service_route()`, `enable_service()`, `disable_service()` ‚Üê **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ routing**

**–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç**:
1. –£–¥–∞–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ–ª–µ–π (`_subscription`)
2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: `[VPN] ‚Üí direct-out ‚Üí dns-out ‚Üí [–¥—Ä—É–≥–∏–µ]`
3. –ù–∞–ª–∏—á–∏–µ TUN inbound (–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)
4. `route.final` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ø–µ—Ä–≤—ã–π VPN (–∏–ª–∏ direct-out, –µ—Å–ª–∏ VPN –Ω–µ—Ç)
5. DNS routing rule –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
6. –í—Å–µ DNS —Å–µ—Ä–≤–µ—Ä—ã –∏–º–µ—é—Ç `detour: "direct-out"`

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
```bash
# Sing-box –∑–∞–ø—É—â–µ–Ω
pgrep sing-box

# –ö–æ–Ω—Ñ–∏–≥ –≤–∞–ª–∏–¥–µ–Ω
sing-box check -c /etc/sing-box/config.json

# LuCI –¥–æ—Å—Ç—É–ø–µ–Ω
# http://<router-ip>/cgi-bin/luci/admin/services/pinpoint
```

### 2. –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å outbounds
cat /etc/sing-box/config.json | grep -A5 '"outbounds"'

# –ü–µ—Ä–≤—ã–π outbound –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å VPN, –ù–ï direct-out!

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
logread | grep sing-box | tail -10

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: outbound/vless[tunnel_name]
# –ù–ï –î–û–õ–ñ–ù–û –ë–´–¢–¨: outbound/direct[direct-out] (–¥–ª—è tunnel —Ç—Ä–∞—Ñ–∏–∫–∞)
```

### 3. –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è Instagram:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Instagram IP –≤ tunnel_ips
nft list set inet pinpoint tunnel_ips | grep "57.144"

# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—å
curl -v https://www.instagram.com

# –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å VPN outbound
logread | grep sing-box | grep instagram
```

### 4. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# –°—Ç–∞—Ç—É—Å
ubus call luci.pinpoint status
# vpn_active: true

# –í–Ω–µ—à–Ω–∏–π IP (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å VPN IP, –µ—Å–ª–∏ routing —Ä–∞–±–æ—Ç–∞–µ—Ç)
curl ifconfig.me
```

## üìã –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

1. **install.sh** - DNS detour –∏ route.final –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ
2. **pinpoint.uc** - clean_config_outbounds —Å –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ–º –∏ route.final
3. **pinpoint.nft** - NFTables priority –∏ conntrack
4. **pinpoint-init.sh** - –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π fwmark –∏ ip rule priority
5. **luci-app-pinpoint.json** - –ú–µ–Ω—é –ø—É—Ç—å (Services, –Ω–µ VPN)

## üöÄ –ò—Ç–æ–≥

**–¢–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–æ–≤–∫–∞ "–ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç"**:
- ‚úÖ –ù–µ—Ç –Ω—É–∂–¥—ã –≤ 100 —Ä—É—á–Ω—ã—Ö –ø—Ä–∞–≤–∫–∞—Ö
- ‚úÖ VPN –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –¢—Ä–∞—Ñ–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ VPN –¥–ª—è –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ DNS –Ω–µ —Å–æ–∑–¥–∞—ë—Ç loopback
- ‚úÖ Routing –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ sing-box

## üì¶ –°—Å—ã–ª–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏

```bash
curl -fsSL https://raw.githubusercontent.com/shep-k-a/pinpoint-openwrt/master/install.sh | sh
```

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
1. –û—Ç–∫—Ä—ã—Ç—å LuCI: `http://<router-ip>/cgi-bin/luci/admin/services/pinpoint`
2. Tunnels ‚Üí Add Subscription ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å URL
3. Update Subscriptions
4. Services ‚Üí Enable –Ω—É–∂–Ω—ã–µ (Instagram, YouTube, etc.)
5. Update Services
6. **–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!** ‚ú®
